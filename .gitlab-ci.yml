
################################################
# GENERATED FILE, DO NOT EDIT
# Please visit runner/README.md
################################################

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CI_REGISTRY: https://index.docker.io/v1/
  CI_REGISTRY_IMAGE: leximpact/openfisca-france-data
  # OUT_FOLDER: "$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA" # For branch-commit_id
  OUT_FOLDER: "$CI_COMMIT_REF_NAME" # For just branch
  ROOT_FOLDER: "/mnt/data-out/openfisca-france-data"

cache:
  paths:
    - .cache/pip
    - ./figures/

stages:
  - docker
  - test
  - anaconda
  - build_collection
  - build_input_data
  - aggregates


before_script:
  # To be sure we are up to date even if we do not rebuild docker image
  - make install
  - cp ./runner/openfisca_survey_manager_raw_data.ini ~/.config/openfisca-survey-manager/raw_data.ini
  - echo "End of before_script"

build docker image:
  stage: docker
  tags:
    - openfisca
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  # Prevent call of before_script because it will fail in this context
  before_script:
    - ''
  script:
    # From https://github.com/GoogleContainerTools/kaniko#pushing-to-docker-hub
    - DOCKER_HUB_AUTH=$(echo -n $DOCKER_HUB_USER:$DOCKER_HUB_PASSWORD | base64)
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$DOCKER_HUB_AUTH\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/docker/Dockerfile --destination $CI_REGISTRY_IMAGE:latest
  # Build Docker is needed only if code as changed.
  when: manual

test:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - make test
  stage: test
  tags:
  - openfisca
deploy_conda:
  before_script:
  - ''
  except:
  - master
  image: continuumio/miniconda3
  script:
  - conda install -y conda-build anaconda-client
  - conda build -c conda-forge -c openfisca --token $ANACONDA_TOKEN --user OpenFisca
    .conda
  stage: anaconda
deploy_conda:
  before_script:
  - ''
  image: continuumio/miniconda3
  only:
  - master
  script:
  - conda install -y conda-build anaconda-client
  - conda config --set anaconda_upload yes
  - conda build -c conda-forge -c openfisca --token $ANACONDA_TOKEN --user OpenFisca
    .conda
  stage: anaconda
build_collection:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - echo "Begin with fresh config"
  - mkdir -p $ROOT_FOLDER/data_collections/$OUT_FOLDER/
  - rm $ROOT_FOLDER/data_collections/$OUT_FOLDER/*.json || true
  - cp ./runner/openfisca_survey_manager_config.ini ~/.config/openfisca-survey-manager/config.ini
  - echo "Custom output folder"
  - sed -i "s/data_collections/data_collections\/$OUT_FOLDER\//" ~/.config/openfisca-survey-manager/config.ini
  - cat ~/.config/openfisca-survey-manager/config.ini
  - '#build-collection -c enquete_logement -d -m -s 2013'
  - build-collection -c erfs_fpr -d -m -v
  - echo "Backup updated config"
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
  stage: build_collection
  tags:
  - openfisca
  when: manual
in_dt-2018:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - echo "build_input_data-2018"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2018 -f $ROOT_FOLDER/$OUT_FOLDER/erfs_flat_2018.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
  stage: build_input_data
  tags:
  - openfisca
agg-2018:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2018
  script:
  - echo "aggregates-2018"
  - cp $ROOT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2018
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER
  stage: aggregates
  tags:
  - openfisca
