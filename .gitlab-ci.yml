
################################################
# GENERATED FILE, DO NOT EDIT
# Please visit ci-runner/README.md
################################################

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CI_REGISTRY: https://index.docker.io/v1/
  CI_REGISTRY_IMAGE: leximpact/openfisca-france-data
  # OUT_FOLDER: "$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA" # For branch-commit_id
  OUT_FOLDER: "$CI_COMMIT_REF_NAME" # For just branch
  ROOT_FOLDER: "/mnt/data-out/openfisca-france-data"

cache:
  paths:
    - .cache/pip
    - ./figures/

stages:
  - docker
  - test
  - build_collection
  - build_input_data
  - aggregates
  - run_on_all_years
  - build_input_data_all
  - aggregates_all
  - anaconda

before_script:
  # To be sure we are up to date even if we do not rebuild docker image
  - make install
  - cp ./ci-runner/openfisca_survey_manager_raw_data.ini ~/.config/openfisca-survey-manager/raw_data.ini
  - echo "End of before_script"

build docker image:
  stage: docker
  tags:
    - openfisca
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  # Prevent call of before_script because it will fail in this context
  before_script:
    - ''
  script:
    # From https://github.com/GoogleContainerTools/kaniko#pushing-to-docker-hub
    - DOCKER_HUB_AUTH=$(echo -n $DOCKER_HUB_USER:$DOCKER_HUB_PASSWORD | base64)
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$DOCKER_HUB_AUTH\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/docker/Dockerfile --destination $CI_REGISTRY_IMAGE:latest
  # Build Docker is needed only if code as changed.
  when: manual


run_on_all_years:
  stage: run_on_all_years
  # Prevent call of before_script because it will fail in this context
  before_script:
    - ''
  script:
    - echo "On ne fait rien"
  when: manual

clean_folder:
  before_script:
    - ''
  script: rm -rf $ROOT_FOLDER/$OUT_FOLDER || true
  stage: build_collection
  tags:
  - openfisca
  when: manual

copy_previous_build_collections:
  before_script:
    - ''
  script: |
    if [[ -f "$ROOT_FOLDER/$OUT_FOLDER/data_collections/erfs_fpr.json" ]]; then
        echo "Files already exists, do nothing."
    else
        rm -rf $ROOT_FOLDER/$OUT_FOLDER || true
        mkdir -p $ROOT_FOLDER/$OUT_FOLDER/data_collections/
        mkdir -p $ROOT_FOLDER/$OUT_FOLDER/data_output/
        cp $ROOT_FOLDER/master/openfisca_survey_manager_config-after-build-collection.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
        sed -i "s/master/$OUT_FOLDER/" $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
        cp $ROOT_FOLDER/master/data_collections/erfs_fpr.json $ROOT_FOLDER/$OUT_FOLDER/data_collections/erfs_fpr.json
        cp ./ci-runner/empty_openfisca_erfs_fpr.json $ROOT_FOLDER/$OUT_FOLDER/data_collections/openfisca_erfs_fpr.json
    fi
  stage: build_collection
  tags:
  - openfisca
  except:
  - master

test:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - make test
  stage: test
  tags:
  - openfisca
build_collection:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - echo "Begin with fresh config"
  - rm -rf $ROOT_FOLDER/$OUT_FOLDER || true
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER/data_collections/
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER/data_output/
  - cp ./ci-runner/openfisca_survey_manager_config.ini ~/.config/openfisca-survey-manager/config.ini
  - echo "Custom output folder"
  - sed -i "s/BRANCH_NAME/$OUT_FOLDER/" ~/.config/openfisca-survey-manager/config.ini
  - 'echo "{\"name\": \"erfs_fpr\", \"surveys\": {}}" > $ROOT_FOLDER/$OUT_FOLDER/data_collections/erfs_fpr.json'
  - 'echo "{\"name\": \"openfisca_erfs_fpr\", \"surveys\": {}}" > $ROOT_FOLDER/$OUT_FOLDER/data_collections/openfisca_erfs_fpr.json'
  - cat ~/.config/openfisca-survey-manager/config.ini
  - '#build-collection -c enquete_logement -d -m -s 2013'
  - build-collection -c erfs_fpr -d -m -v
  - echo "Backup updated config"
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
  stage: build_collection
  tags:
  - openfisca
  when: manual
input_data-2018:
  image: $CI_REGISTRY_IMAGE:latest
  script:
  - echo "build_input_data-2018"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2018 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2018.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
  stage: build_input_data
  tags:
  - openfisca
aggregates-2018:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - input_data-2018
  script:
  - echo "aggregates-2018"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2018
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates
  tags:
  - openfisca
in_dt-1996:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-1996"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 1996 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_1996.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1996.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-1996:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-1996
  script:
  - echo "aggregates-1996"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1996.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 1996
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-1997:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-1997"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 1997 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_1997.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1997.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-1997:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-1997
  script:
  - echo "aggregates-1997"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1997.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 1997
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-1998:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-1998"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 1998 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_1998.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1998.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-1998:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-1998
  script:
  - echo "aggregates-1998"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1998.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 1998
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-1999:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-1999"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 1999 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_1999.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1999.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-1999:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-1999
  script:
  - echo "aggregates-1999"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-1999.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 1999
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2000:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2000"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2000 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2000.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2000.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2000:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2000
  script:
  - echo "aggregates-2000"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2000.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2000
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2001:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2001"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2001 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2001.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2001.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2001:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2001
  script:
  - echo "aggregates-2001"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2001.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2001
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2002:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2002"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2002 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2002.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2002.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2002:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2002
  script:
  - echo "aggregates-2002"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2002.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2002
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2003:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2003"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2003 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2003.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2003.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2003:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2003
  script:
  - echo "aggregates-2003"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2003.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2003
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2004:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2004"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2004 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2004.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2004.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2004:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2004
  script:
  - echo "aggregates-2004"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2004.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2004
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2005:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2005"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2005 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2005.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2005.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2005:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2005
  script:
  - echo "aggregates-2005"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2005.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2005
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2006:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2006"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2006 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2006.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2006.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2006:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2006
  script:
  - echo "aggregates-2006"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2006.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2006
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2007:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2007"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2007 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2007.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2007.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2007:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2007
  script:
  - echo "aggregates-2007"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2007.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2007
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2008:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2008"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2008 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2008.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2008.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2008:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2008
  script:
  - echo "aggregates-2008"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2008.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2008
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2009:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2009"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2009 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2009.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2009.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2009:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2009
  script:
  - echo "aggregates-2009"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2009.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2009
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2010:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2010"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2010 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2010.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2010.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2010:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2010
  script:
  - echo "aggregates-2010"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2010.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2010
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2011:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2011"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2011 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2011.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2011.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2011:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2011
  script:
  - echo "aggregates-2011"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2011.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2011
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2012:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2012"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2012 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2012.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2012.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2012:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2012
  script:
  - echo "aggregates-2012"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2012.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2012
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2013:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2013"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2013 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2013.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2013.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2013:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2013
  script:
  - echo "aggregates-2013"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2013.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2013
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2014:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2014"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2014 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2014.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2014.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2014:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2014
  script:
  - echo "aggregates-2014"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2014.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2014
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2015:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2015"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2015 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2015.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2015.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2015:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2015
  script:
  - echo "aggregates-2015"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2015.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2015
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2016:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2016"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2016 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2016.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2016.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2016:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2016
  script:
  - echo "aggregates-2016"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2016.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2016
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2017:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2017"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2017 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2017.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2017.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2017:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2017
  script:
  - echo "aggregates-2017"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2017.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2017
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2018:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2018"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2018 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2018.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2018:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2018
  script:
  - echo "aggregates-2018"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2018.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2018
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
in_dt-2019:
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - run_on_all_years
  script:
  - echo "build_input_data-2019"
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config-after-build-collection.ini
    ~/.config/openfisca-survey-manager/config.ini
  - build-erfs-fpr -y 2019 -f $ROOT_FOLDER/$OUT_FOLDER/data_output/erfs_flat_2019.h5
  - cp ~/.config/openfisca-survey-manager/config.ini $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2019.ini
  stage: build_input_data_all
  tags:
  - openfisca
agg-2019:
  artifacts:
    paths:
    - ./*.html
    - ./*.csv
  image: $CI_REGISTRY_IMAGE:latest
  needs:
  - in_dt-2019
  script:
  - echo "aggregates-2019"
  - cp $ROOT_FOLDER/$OUT_FOLDER/openfisca_survey_manager_config_input_data-after-build-erfs-fprs-2019.ini
    ~/.config/openfisca-survey-manager/config.ini
  - python tests/erfs_fpr/integration/test_aggregates.py --year 2019
  - mkdir -p $ROOT_FOLDER/$OUT_FOLDER
  - cp ./*.html $ROOT_FOLDER/$OUT_FOLDER/data_output
  - cp ./*.csv $ROOT_FOLDER/$OUT_FOLDER/data_output
  stage: aggregates_all
  tags:
  - openfisca
build_conda_package:
  before_script:
  - ''
  except:
  - master
  image: continuumio/miniconda3
  script:
  - conda install -y conda-build anaconda-client
  - conda build -c conda-forge -c openfisca --token $ANACONDA_TOKEN --user OpenFisca
    .conda
  stage: anaconda
